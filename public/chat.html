<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>brainbase chat</title>
        <link href="https://gtml.gavingogamingrepl.repl.co/regular-ass-style.css" rel="stylesheet" />
        <link href="https://unpkg.com/movement.css/movement.css" rel="stylesheet" />
    </head>
    <body>
  
      <div class="menu-icon"><i class='fa-solid  fa-bars'></i></div>
      <div class="close-icon"><i class='fa-solid  fa-circle-xmark'></i></div>
        <nav class="nav"></nav>
        <center class="content">
          <style>@import url('/chat.css');@import url('/navs.css');</style>
<!--             <h1>Brainbase Chat</h1> -->
            <ul class="chat">
                <li class='titleBar'>
                    <i class="fa-duotone fa-2x fa-brain-circuit"></i>
                    <b><a style='font-size:26px'>Brainbase - Chat</a></b>
                    <i class="fa-duotone fa-user fa-2x"></i>
                </li>
            </ul>
            <br />
            <textarea placeholder="Reply..." id="question" type="text"></textarea><br />
            <div class="parent">
              <div class="left-child" style="margin-top: 10px;">
                <input type="checkbox" id="slang" placeholder="" />Enable texting mode<br />
                <input type="checkbox" id="short" checked="true" />Shorter content<br />
                <input type="checkbox" id="danmode" />COMING SOON - DAN (Do Anything Now)<br />
              </div>
              <div class="right-child">
                <button class=big onclick="addOn()">Send<i class="fa-solid fa-paper-plane"></i></button><br />
              </div>
            </div>
            <div class="split-three">
              <div class="s3-left-child">
                <button onclick="saveConvo()"><a>Save <i class="fa-duotone fa-download"></i></a></button>
                <button onclick="loadConvo()"><a>Load <i class="fa-duotone fa-upload"></i></a></button><br />
              </div>
              <div class="s3-middle-child">
                <button onclick="deleteConvo()"><a>Delete Saved <i class="fa-solid fa-circle-xmark"></i></a></button><br />
              </div>
              <div class="s3-right-child">
                <button onclick="window.location.href='/chatbot/customization'"><a>Customization <i class="fa-duotone fa-paintbrush-pencil"></i></a></button><br />
              </div>
            </div>
        </center>
        <script>
          var helper = {
 // Remove and return the first occurrence

 remove: function(array, predicate) {
  for (var i = 0; i < array.length; i++) {
   if (predicate(array[i])) {
    return array.splice(i, 1);
   }
  }
 },

 // Remove and return all occurrences

 removeAll: function(array, predicate) {
  var removed = [];

  for (var i = 0; i < array.length; ) {
   if (predicate(array[i])) {
    removed.push(array.splice(i, 1));
    continue;
   }
   i++;
  }
  return removed;
 },
};
            let history = [];
            function saveConvo() {
              var Format = `${JSON.stringify(history)}`;
              if(window.localStorage.savedConversations==null||window.localStorage.savedConversations==''||window.localStorage.savedConversations==" "){
                window.localStorage.savedConversations='[]';
              }
              var name = prompt("Name to save the conversation as?");
              var savedCS = JSON.parse(window.localStorage.savedConversations);
              savedCS.push({
                name: name,
                convo: Format
              });
              window.localStorage.savedConversations = JSON.stringify(savedCS);
              alert("Saved!");
            }

            function deleteConvo() {
              if(window.localStorage.savedConversations==null||window.localStorage.savedConversations==''||window.localStorage.savedConversations==" "){
                window.localStorage.savedConversations='[]';
              }
              var convos = "";
              for(var CV of JSON.parse(window.localStorage.savedConversations)) {
                convos += "\n"+CV.name;
              }
              var name = prompt("Enter convo name out of these:"+convos, "");
              var comp = false;
              JSON.parse(window.localStorage.savedConversations).forEach(item => {
                if(item.name === name) {
                  var osc = JSON.parse(window.localStorage.savedConversations);
                  var remmed = helper.removeAll(osc, it=>it.name.startsWith(item.name));
                  window.localStorage.savedConversations = JSON.stringify(osc);
                  comp = true;
                  alert('Removed');
                }
              });
              if(!comp) alert("Couldnt find that one.");
            }
            function loadConvo() {
              if(window.localStorage.savedConversations==null||window.localStorage.savedConversations==''||window.localStorage.savedConversations==" "){
                window.localStorage.savedConversations='[]';
              }
              var convos = "";
              for(var CV of JSON.parse(window.localStorage.savedConversations)) {
                convos += "\n"+CV.name;
              }
              var name = prompt("Enter convo name out of these:"+convos, "");
              var comp = false;
              JSON.parse(window.localStorage.savedConversations).forEach(item => {
                if(item.name === name) {
                  history = JSON.parse(item.convo);
                  var chatList = document.querySelector('.chat');
                  var content = `<ul class="chat">
                <li class='titleBar'>
                    <i class="fa-duotone fa-2x fa-brain-circuit"></i>
                    <b><a style='font-size:26px'>Brainbase - Chat</a></b>
                    <i class="fa-duotone fa-user fa-2x"></i>
                </li>`;
                  for(var hI of history) {
                    content += `<li><center><div style="text-align:left;"><i class='fa-duotone fa-${hI.person == 'Brainbase' ? 'brain-circuit' : 'user'}' style='scale:1.3;'></i> <a style='margin-left:1${hI.person == 'Brainbase' ? '0' : '2'}px;'>${hI.answer.replaceAll(/```(.+)```/g, '<pre><code>$1</code></pre>').replaceAll(/`(.+)`/g, '<code class=nohighlight>$1</code>').replaceAll("\n", "<br>")}</a></div></center></li>`;
                  }
                  content += `</ul>`
                  chatList.outerHTML = content;
                  alert("Loaded!");
                  hljs.highlightAll();
                  comp = true;
                }
              });
              if(!comp) alert("Not found.");
            }
            function handleResponse(jres) {
                if (jres.isError) {
                    document.body.innerHTML = JSON.stringify(jres);
                }
                history.push({
                  answer: jres.answer,
                  person: 'Brainbase'
                });
                for (var l of jres.answer.split(">/>")) {
                    document
                        .querySelector(".chat")
                        .insertAdjacentHTML(
                            "beforeend",
                            `<li><center><div style="text-align:left;"><i class='fa-duotone fa-brain-circuit' style='scale:1.3;'></i> <a style='margin-left:10px;'>${l.replaceAll(/```([\s\S]+?)```/g, '<pre><code>$1</code></pre>').replaceAll("\n", "<br>")}</a></div></center></li>`
                        );
                }
                hljs.highlightAll();
            }
            function formatHistory() {
              var historyF = "";
              for(var h of history) {
                historyF += h.person + ": " + h.answer + "\n"
              }
              return historyF;
            }
            function question() {
                var v = document.querySelector("#question").value;
                document.querySelector("#question").value = "";
                return v;
            }
            function addOn() {
                var q = question().trim();
                var slang = document.querySelector("#slang").checked;
                var short = document.querySelector("#short").checked;
                if (q.trim() == null || q.trim() == "" || q.trim() == " ") {
                    return;
                }
                document
                    .querySelector(".chat")
                    .insertAdjacentHTML("beforeend", `<li><div style="text-align:left;"><i class='fa-duotone fa-user' style='scale:1.3;'></i> <a style='margin-left:12px;'>${q.replaceAll("\n", "<br>")}</a></div></li>`);
                history.push({answer: q, person: 'Human'});
                const params = { history: history };
                fetch(
                    "/chatbotresponse" +
                        "?question=" +
                        q +
                        "" +
                        (slang ? "&slang=true" : "&slang=f") +
                        "" +
                        (short ? "&short=true" : "&short=f") +
                        "&person=" +
                        window.localStorage.personality +
                        "&character=" +
                        window.localStorage.character,
                    {
                        method: "POST",
                        body: JSON.stringify(params),
                        headers: {
                            "Content-Type": "application/json",
                        },
                    }
                )
                    .then((res) => res.json())
                    .then((jres) => handleResponse(jres));
            }
            document.querySelector('#question').addEventListener('keydown', function(event) {
              if (event.shiftKey && event.keyCode === 13) {
                // Add a new line
                // this.value += '\n';
              } else if (event.keyCode === 13) {
                event.preventDefault();
                addOn();
                this.rows = 1;
                this.rows = this.scrollHeight/20;
              }
            });
            document.querySelector('#question').addEventListener('input', function(event) {
                this.rows = 1;
                this.rows = this.scrollHeight/20;
            });
        </script>
        <script src="Public.js"></script>
    </body>
</html>
